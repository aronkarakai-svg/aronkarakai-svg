<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Majom a f√°n ‚Äì Bal vagy Jobb</title>

  <style>
    :root{
      --bg1:#c7f5ff;
      --bg2:#eafff5;
      --panel: rgba(255,255,255,.78);
      --text:#083344;
      --shadow: 0 12px 30px rgba(0,0,0,.14);

      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
      --safeLeft: env(safe-area-inset-left);
      --safeRight: env(safe-area-inset-right);

      --treeCol: clamp(140px, 22vw, 220px);
      --hudH: 78px; /* 2 soros fejl√©cnek */
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
    }

    body{
      min-height: 100svh;
      min-height: 100dvh;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
    }

    .app{
      height: 100svh;
      height: 100dvh;
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding:
        calc(10px + var(--safeTop))
        calc(10px + var(--safeRight))
        calc(10px + var(--safeBottom))
        calc(10px + var(--safeLeft));
    }

    .topbar{
      min-height: var(--hudH);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 18px;
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .stat{
      display:flex;
      flex-direction:column; /* 2 sor */
      gap:6px;
      font-size: 16px;
      font-weight: 950;
      line-height: 1.1;
      white-space: nowrap;
    }
    .statRow{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .hearts, .stars{ display:flex; gap:6px; }
    .heart, .star{ font-size: 22px; filter: drop-shadow(0 2px 0 rgba(0,0,0,.08)); }
    .muted{ opacity:.28; filter:none; }

    .controls{
      display:flex;
      gap:10px;
      margin-left:auto;
      align-items:center;
      padding-top: 4px;
    }

    button{
      border:0;
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 950;
      min-height: 44px;
      color:#fff;
      background: linear-gradient(180deg, #0ea5e9, #0284c7);
      box-shadow: 0 10px 20px rgba(2,132,199,.22);
    }
    button:active{ transform: translateY(1px); }
    .btn-secondary{
      background: rgba(8,51,68,.10);
      color: var(--text);
      box-shadow:none;
    }
    .btn-secondary:active{ background: rgba(8,51,68,.14); }

    .main{
      position:relative;
      flex:1;
      border-radius: 22px;
      overflow:hidden;
      box-shadow: var(--shadow);
      background:
        radial-gradient(900px 480px at 50% 20%, rgba(255,255,255,.62), rgba(255,255,255,0)),
        linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.18));
      backdrop-filter: blur(6px);
    }

    .prompt{
      position:absolute;
      left:50%;
      top: 12px;
      transform: translateX(-50%);
      z-index: 5;
      background: rgba(255,255,255,.86);
      border-radius: 18px;
      padding: 10px 14px;
      font-weight: 1000;
      font-size: clamp(16px, 2.2vw, 20px);
      box-shadow: 0 10px 22px rgba(0,0,0,.12);
      backdrop-filter: blur(10px);
      text-align:center;
      max-width: min(520px, 92vw);
      pointer-events:none;
    }
    .prompt small{
      display:block;
      font-weight: 900;
      opacity:.75;
      font-size: 12px;
      margin-top: 3px;
    }

    .playfield{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns: 1fr var(--treeCol) 1fr;
      gap: 10px;
      padding: 18px;
      padding-top: calc(18px + 62px);
      align-items: stretch;
    }

    .tapzone{
      position:relative;
      border-radius: 22px;
      border: 2px solid rgba(255,255,255,.55);
      background: rgba(255,255,255,.18);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: clamp(30px, 7vw, 46px);
      font-weight: 1000;
      letter-spacing: .5px;
      color: rgba(8,51,68,.86);
    }
    .tapzone:active{
      transform: scale(.995);
      background: rgba(255,255,255,.26);
    }
    .tapzone .hint{
      position:absolute;
      bottom: 16px;
      font-size: 12px;
      font-weight: 950;
      opacity:.55;
      letter-spacing: .2px;
    }

    .treeWrap{
      position:relative;
      border-radius: 22px;
      background: rgba(255,255,255,.10);
      border: 2px solid rgba(255,255,255,.45);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.10);
      overflow:hidden;
    }

    .leaves{
      position:absolute;
      left:50%;
      top: 6%;
      width: 150%;
      height: 26%;
      transform: translateX(-50%);
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 30%, #caffdc, transparent 42%),
        radial-gradient(circle at 65% 35%, #caffdc, transparent 48%),
        linear-gradient(180deg, #2ecc71, #27ae60);
      box-shadow: inset 0 0 0 5px rgba(255,255,255,.10);
      opacity:.95;
    }

    .trunk{
      position:absolute;
      left:50%;
      bottom:-18px;
      width: 56%;
      height: 86%;
      transform: translateX(-50%);
      border-radius: 999px;
      background: linear-gradient(90deg, #6f451f, #8b5a2b);
      box-shadow: inset 0 0 0 4px rgba(255,255,255,.07);
    }

    .monkey{
      position:absolute;
      left:50%;
      bottom: 10%;
      transform: translate(-50%, 0);
      font-size: clamp(42px, 6vw, 56px);
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.18));
      transition: transform 420ms cubic-bezier(.2,.8,.2,1);
      z-index: 3;
      will-change: transform;
    }

    .monkey.falling{ animation: fall 900ms ease-in forwards; }
    @keyframes fall{
      0%   { transform: translate(-50%, 0) rotate(0deg); }
      40%  { transform: translate(-50%, 140px) rotate(25deg); }
      100% { transform: translate(-50%, 520px) rotate(120deg); opacity: .25; }
    }

    .flash-ok{ animation: flashOk 240ms ease; }
    .flash-bad{ animation: flashBad 240ms ease; }
    @keyframes flashOk{ 0%{ background: rgba(34,197,94,.18);} 100%{ background: rgba(255,255,255,.18);} }
    @keyframes flashBad{ 0%{ background: rgba(239,68,68,.18);} 100%{ background: rgba(255,255,255,.18);} }

    /* ===== START OVERLAY (NAGY START) ===== */
    .startOverlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
      padding: 18px;
      z-index: 12;
    }
    .startOverlay.hidden{ display:none; }

    .startCard{
      width: min(520px, 92vw);
      background: rgba(255,255,255,.92);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      text-align:center;
    }
    .startCard h1{
      margin: 0 0 8px 0;
      font-size: 28px;
      letter-spacing:.2px;
    }
    .startCard p{
      margin: 0 0 14px 0;
      font-size: 16px;
      opacity:.86;
      line-height: 1.35;
    }
    .bigStart{
      font-size: 20px;
      min-height: 56px;
      padding: 14px 18px;
      width: min(320px, 92%);
      border-radius: 18px;
      animation: pulse 1.25s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ transform: scale(1); }
      50%{ transform: scale(1.03); }
      100%{ transform: scale(1); }
    }
    .startNote{
      margin-top: 10px;
      font-size: 12px;
      opacity:.68;
      font-weight: 900;
    }

    /* ===== GAME OVER OVERLAY ===== */
    .overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      padding: 18px;
      z-index: 11;
    }
    .overlay.show{ display:flex; }

    .card{
      width: min(520px, 92vw);
      background: rgba(255,255,255,.90);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      text-align:center;
    }
    .card h1{ margin: 0 0 6px 0; font-size: 28px; }
    .card p{ margin: 0 0 14px 0; font-size: 16px; opacity:.85; line-height: 1.35; }
    .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  </style>
</head>

<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="stat" aria-label="√âletek √©s csillagok">
        <div class="statRow">
          <span>√âlet:</span>
          <div class="hearts" id="hearts"></div>
        </div>
        <div class="statRow">
          <span>Csillag:</span>
          <div class="stars" id="stars"></div>
        </div>
      </div>

      <div class="controls">
        <button class="btn-secondary" id="repeatBtn" type="button">üîä Ism√©tl√©s</button>
      </div>
    </div>

    <div class="main" id="main">
      <div class="prompt" id="prompt">
        Nyomd meg a START-ot!
        <small>Ut√°na √©n mondom: bal vagy jobb</small>
      </div>

      <div class="playfield">
        <div class="tapzone" id="leftBtn" role="button" aria-label="Bal gomb">
          BAL
          <div class="hint">bal oldal</div>
        </div>

        <div class="treeWrap" aria-hidden="true">
          <div class="leaves"></div>
          <div class="trunk" id="trunk"></div>
          <div class="monkey" id="monkey">üêí</div>
        </div>

        <div class="tapzone" id="rightBtn" role="button" aria-label="Jobb gomb">
          JOBB
          <div class="hint">jobb oldal</div>
        </div>
      </div>

      <!-- BIG START OVERLAY -->
      <div class="startOverlay" id="startOverlay">
        <div class="startCard">
          <h1>üêí Majom a f√°n</h1>
          <p>√ân mondom: <b>bal</b> vagy <b>jobb</b>. Nyomd meg a helyes oldalt!</p>
          <button class="bigStart" id="startBtn" type="button">‚ñ∂Ô∏è START</button>
          <div class="startNote">Tipp: nagy BAL/JOBB mez≈ëkre nyomj</div>
        </div>
      </div>

      <!-- GAME OVER / CHAMPION OVERLAY -->
      <div class="overlay" id="overlay">
        <div class="card">
          <h1 id="endTitle">V√©ge</h1>
          <p id="endText">Kezdj√ºk √∫jra?</p>
          <div class="row">
            <button id="restartBtn" type="button">üîÅ √öj j√°t√©k</button>
            <button class="btn-secondary" id="closeOverlayBtn" type="button">‚úã M√©gse</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const heartsEl = document.getElementById('hearts');
      const starsEl  = document.getElementById('stars');
      const promptEl = document.getElementById('prompt');
      const monkeyEl = document.getElementById('monkey');

      const leftBtn  = document.getElementById('leftBtn');
      const rightBtn = document.getElementById('rightBtn');

      const repeatBtn= document.getElementById('repeatBtn');

      const startOverlay = document.getElementById('startOverlay');
      const startBtn = document.getElementById('startBtn');

      const overlay  = document.getElementById('overlay');
      const endTitle = document.getElementById('endTitle');
      const endText  = document.getElementById('endText');
      const restartBtn = document.getElementById('restartBtn');
      const closeOverlayBtn = document.getElementById('closeOverlayBtn');

      // ===== Game state =====
      const MAX_LIVES = 3;
      const STREAK_FOR_STAR = 5;
      const MAX_STARS = 5;

      let lives = MAX_LIVES;
      let correctCount = 0;
      let stars = 0;
      let running = false;
      let current = null; // "left" | "right"
      let canAnswer = false;

      // ===== Queue: speech + sfx in order (no interruption) =====
      let audioQueue = Promise.resolve();
      function enqueue(taskFn) {
        audioQueue = audioQueue.then(() => taskFn()).catch(() => {});
        return audioQueue;
      }

      // ===== Speech (no cancel) =====
      const synth = window.speechSynthesis;

      function pickHungarianVoice() {
        const voices = synth.getVoices?.() || [];
        return voices.find(v => (v.lang || '').toLowerCase().startsWith('hu')) || null;
      }
      let voice = null;

      function speakAsync(text) {
        return new Promise((resolve) => {
          if (!synth) return resolve();

          const u = new SpeechSynthesisUtterance(text);
          u.lang = 'hu-HU';
          u.rate = 0.95;
          u.pitch = 1.05;
          if (voice) u.voice = voice;

          u.onend = () => resolve();
          u.onerror = () => resolve();

          synth.speak(u);
        });
      }

      function speakQueued(text) {
        return enqueue(() => {
          // besz√©d k√∂zben ne fogadjunk v√°laszt
          canAnswer = false;
          return speakAsync(text).then(() => {
            canAnswer = true;
          });
        });
      }

      // ===== SFX (Web Audio) =====
      let audioCtx = null;

      function ensureAudioContext() {
        if (!audioCtx) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (Ctx) audioCtx = new Ctx();
        }
        if (audioCtx && audioCtx.state === 'suspended') {
          return audioCtx.resume().catch(() => {});
        }
        return Promise.resolve();
      }

      function beepSequence() {
        return new Promise(async (resolve) => {
          await ensureAudioContext();
          if (!audioCtx) return resolve();

          const now = audioCtx.currentTime;
          const master = audioCtx.createGain();
          master.gain.setValueAtTime(0.0001, now);
          master.gain.exponentialRampToValueAtTime(0.08, now + 0.01);
          master.gain.exponentialRampToValueAtTime(0.0001, now + 0.35);
          master.connect(audioCtx.destination);

          // 2 gyors csilingel≈ë "ding"
          const o1 = audioCtx.createOscillator();
          const o2 = audioCtx.createOscillator();
          o1.type = 'sine';
          o2.type = 'triangle';
          o1.frequency.setValueAtTime(880, now);
          o1.frequency.exponentialRampToValueAtTime(1320, now + 0.12);
          o2.frequency.setValueAtTime(1760, now + 0.12);
          o2.frequency.exponentialRampToValueAtTime(990, now + 0.28);

          o1.connect(master);
          o2.connect(master);

          o1.start(now);
          o2.start(now + 0.10);
          o1.stop(now + 0.18);
          o2.stop(now + 0.34);

          setTimeout(resolve, 380);
        });
      }

      function sfxQueuedGood() {
        return enqueue(() => {
          // hangeffekt k√∂zben sem kell kattintani
          canAnswer = false;
          return beepSequence().then(() => {
            canAnswer = true;
          });
        });
      }

      // ===== UI helpers =====
      function renderLives() {
        heartsEl.innerHTML = '';
        for (let i = 0; i < MAX_LIVES; i++) {
          const s = document.createElement('span');
          s.className = 'heart' + (i < lives ? '' : ' muted');
          s.textContent = '‚ù§Ô∏è';
          heartsEl.appendChild(s);
        }
      }

      function renderStars() {
        starsEl.innerHTML = '';
        for (let i = 0; i < MAX_STARS; i++) {
          const s = document.createElement('span');
          s.className = 'star' + (i < stars ? '' : ' muted');
          s.textContent = '‚≠ê';
          starsEl.appendChild(s);
        }
      }

      function setPrompt(text, sub = '') {
        promptEl.innerHTML = `${text}${sub ? `<small>${sub}</small>` : ''}`;
      }

      function randomDirection() {
        return Math.random() < 0.5 ? 'left' : 'right';
      }

      function updateMonkeyPosition() {
        const trunk = document.getElementById('trunk');
        if (!trunk) return;

        const trunkRect = trunk.getBoundingClientRect();
        const maxClimb = Math.max(0, trunkRect.height - 90);
        const steps = 20;
        const step = Math.min(correctCount, steps);
        const y = -(maxClimb * (step / steps));

        monkeyEl.classList.remove('falling');
        monkeyEl.style.transform = `translate(-50%, ${y}px)`;
      }

      function flash(btnEl, ok) {
        btnEl.classList.remove('flash-ok', 'flash-bad');
        void btnEl.offsetWidth;
        btnEl.classList.add(ok ? 'flash-ok' : 'flash-bad');
      }

      function showStartOverlay(show) {
        if (show) startOverlay.classList.remove('hidden');
        else startOverlay.classList.add('hidden');
      }

      function endGame(reason) {
        running = false;
        canAnswer = false;

        if (reason === 'lose') {
          monkeyEl.classList.add('falling');
          setPrompt('J√°t√©k v√©ge', 'A majom leesett üôà');
          speakQueued('J√°t√©k v√©ge. A majom leesett a f√°r√≥l.');
          endTitle.textContent = 'J√°t√©k v√©ge';
          endText.textContent = 'Pr√≥b√°ljuk √∫jra!';
        } else if (reason === 'champion') {
          setPrompt('TE VAGY A BAJNOK! üèÜ', 'Szuper volt!');
          speakQueued('Te vagy a bajnok!');
          endTitle.textContent = 'Te vagy a bajnok! üèÜ';
          endText.textContent = 'Szeretn√©l √∫j j√°t√©kot?';
        }

        overlay.classList.add('show');
      }

      function nextRound() {
        current = randomDirection();
        const word = current === 'left' ? 'bal' : 'jobb';
        setPrompt(`Most: ${word.toUpperCase()}!`, 'Nyomd meg a helyes oldalt');

        // besz√©d queue-ban, nem v√°g el semmit
        speakQueued(word);
      }

      function handleAnswer(side) {
        if (!running || !canAnswer || !current) return;

        const ok = (side === current);
        const btnEl = side === 'left' ? leftBtn : rightBtn;

        if (ok) {
          flash(btnEl, true);
          correctCount += 1;
          updateMonkeyPosition();

          // J√≥ v√°lasz hang: queue-ban, nem szak√≠tja meg a besz√©det
          sfxQueuedGood();

          // Csillag minden 5 j√≥ ut√°n
          if (correctCount % STREAK_FOR_STAR === 0) {
            stars = Math.min(MAX_STARS, stars + 1);
            renderStars();
            speakQueued('Csillag!');
            if (stars >= MAX_STARS) {
              // v√°rjuk meg a queue-t, azt√°n bajnok
              enqueue(() => Promise.resolve()).then(() => endGame('champion'));
              return;
            }
          }

          // k√∂vetkez≈ë feladat: queue v√©g√©re tessz√ºk, hogy ne √ºtk√∂zz√∂n
          enqueue(() => new Promise(r => setTimeout(r, 180))).then(() => {
            if (running) nextRound();
          });

        } else {
          flash(btnEl, false);
          lives -= 1;
          renderLives();

          if (lives <= 0) {
            endGame('lose');
            return;
          }

          const word = current === 'left' ? 'bal' : 'jobb';
          setPrompt(`Nem baj! Pr√≥b√°ld √∫jra: ${word.toUpperCase()}!`, `Maradt √©let: ${lives}`);

          // ugyanazt megism√©tli, queue-ban
          speakQueued(`Nem baj. Pr√≥b√°ld √∫jra. ${word}`);
        }
      }

      function resetGame() {
        lives = MAX_LIVES;
        correctCount = 0;
        stars = 0;
        current = null;
        running = false;
        canAnswer = false;

        renderLives();
        renderStars();
        monkeyEl.classList.remove('falling');
        monkeyEl.style.transform = 'translate(-50%, 0)';
        setPrompt('Nyomd meg a START-ot!', 'Ut√°na √©n mondom: bal vagy jobb');
        overlay.classList.remove('show');
        showStartOverlay(true);
      }

      // Voices load async on iOS
      function initVoices() {
        voice = pickHungarianVoice();
      }
      if ('speechSynthesis' in window) {
        initVoices();
        window.speechSynthesis.onvoiceschanged = () => initVoices();
      }

      // ===== Events =====
      startBtn.addEventListener('click', async () => {
        if (!('speechSynthesis' in window)) {
          setPrompt('Sajnos ezen a b√∂ng√©sz≈ën nincs besz√©d.', 'Pr√≥b√°ld Safari-ban iPhone-on');
          return;
        }

        // iOS: audio context unlock on user gesture
        await ensureAudioContext();

        overlay.classList.remove('show');
        monkeyEl.classList.remove('falling');
        showStartOverlay(false);

        running = true;

        setPrompt('K√©szen √°llsz?', 'Mindj√°rt mondom...');

        // els≈ë k√∂r queue-ban
        enqueue(() => new Promise(r => setTimeout(r, 250))).then(() => nextRound());
      });

      repeatBtn.addEventListener('click', () => {
        if (!running || !current) {
          speakQueued('Nyomd meg a startot!');
          return;
        }
        const word = current === 'left' ? 'bal' : 'jobb';
        speakQueued(word);
      });

      leftBtn.addEventListener('click', () => handleAnswer('left'));
      rightBtn.addEventListener('click', () => handleAnswer('right'));

      restartBtn.addEventListener('click', async () => {
        await ensureAudioContext();
        resetGame();
        overlay.classList.remove('show');
        showStartOverlay(false);
        running = true;
        enqueue(() => new Promise(r => setTimeout(r, 250))).then(() => nextRound());
      });

      closeOverlayBtn.addEventListener('click', () => {
        overlay.classList.remove('show');
        // ha bez√°rja, visszaj√∂n a start overlay, hogy egy√©rtelm≈± legyen az ind√≠t√°s
        showStartOverlay(true);
      });

      // Init
      resetGame();
    })();
  </script>
</body>
</html>
