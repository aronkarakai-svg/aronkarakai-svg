<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Majom a f√°n ‚Äì Bal vagy Jobb</title>

  <style>
    :root{
      --bg1:#c7f5ff;
      --bg2:#eafff5;
      --panel: rgba(255,255,255,.78);
      --text:#083344;

      --shadow: 0 12px 30px rgba(0,0,0,.14);

      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
      --safeLeft: env(safe-area-inset-left);
      --safeRight: env(safe-area-inset-right);

      /* middle column width scales with screen */
      --treeCol: clamp(140px, 22vw, 220px);
      --hudH: 64px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
    }

    body{
      min-height: 100svh;
      min-height: 100dvh;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
    }

    .app{
      height: 100svh;
      height: 100dvh;
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding:
        calc(10px + var(--safeTop))
        calc(10px + var(--safeRight))
        calc(10px + var(--safeBottom))
        calc(10px + var(--safeLeft));
    }

    .topbar{
      height: var(--hudH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      border-radius: 18px;
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .stat{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 18px;
      font-weight: 950;
      white-space: nowrap;
    }
    .hearts, .stars{ display:flex; gap:6px; }
    .heart, .star{ font-size: 22px; filter: drop-shadow(0 2px 0 rgba(0,0,0,.08)); }
    .muted{ opacity:.28; filter:none; }

    .controls{
      display:flex;
      gap:10px;
      margin-left:auto;
      align-items:center;
    }

    button{
      border:0;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 15px;
      font-weight: 950;
      min-height: 42px;
      color:#fff;
      background: linear-gradient(180deg, #0ea5e9, #0284c7);
      box-shadow: 0 10px 20px rgba(2,132,199,.22);
    }
    button:active{ transform: translateY(1px); }
    .btn-secondary{
      background: rgba(8,51,68,.10);
      color: var(--text);
      box-shadow:none;
    }
    .btn-secondary:active{ background: rgba(8,51,68,.14); }

    .main{
      position:relative;
      flex:1;
      border-radius: 22px;
      overflow:hidden;
      box-shadow: var(--shadow);
      background:
        radial-gradient(900px 480px at 50% 20%, rgba(255,255,255,.62), rgba(255,255,255,0)),
        linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.18));
      backdrop-filter: blur(6px);
    }

    .prompt{
      position:absolute;
      left:50%;
      top: 12px;
      transform: translateX(-50%);
      z-index: 5;
      background: rgba(255,255,255,.86);
      border-radius: 18px;
      padding: 10px 14px;
      font-weight: 1000;
      font-size: clamp(16px, 2.2vw, 20px);
      box-shadow: 0 10px 22px rgba(0,0,0,.12);
      backdrop-filter: blur(10px);
      text-align:center;
      max-width: min(520px, 92vw);
    }
    .prompt small{
      display:block;
      font-weight: 900;
      opacity:.75;
      font-size: 12px;
      margin-top: 3px;
    }

    /* BAL | FA | JOBB */
    .playfield{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns: 1fr var(--treeCol) 1fr;
      gap: 10px;
      padding: 18px;
      padding-top: calc(18px + 62px); /* room for prompt */
      align-items: stretch;
    }

    .tapzone{
      position:relative;
      border-radius: 22px;
      border: 2px solid rgba(255,255,255,.55);
      background: rgba(255,255,255,.18);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: clamp(30px, 7vw, 46px);
      font-weight: 1000;
      letter-spacing: .5px;
      color: rgba(8,51,68,.86);
    }
    .tapzone:active{
      transform: scale(.995);
      background: rgba(255,255,255,.26);
    }

    .tapzone .hint{
      position:absolute;
      bottom: 16px;
      font-size: 12px;
      font-weight: 950;
      opacity:.55;
      letter-spacing: .2px;
    }

    .treeWrap{
      position:relative;
      border-radius: 22px;
      background: rgba(255,255,255,.10);
      border: 2px solid rgba(255,255,255,.45);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.10);
      overflow:hidden;
    }

    .leaves{
      position:absolute;
      left:50%;
      top: 6%;
      width: 150%;
      height: 26%;
      transform: translateX(-50%);
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 30%, #caffdc, transparent 42%),
        radial-gradient(circle at 65% 35%, #caffdc, transparent 48%),
        linear-gradient(180deg, #2ecc71, #27ae60);
      box-shadow: inset 0 0 0 5px rgba(255,255,255,.10);
      opacity:.95;
    }

    .trunk{
      position:absolute;
      left:50%;
      bottom:-18px;
      width: 56%;
      height: 86%;
      transform: translateX(-50%);
      border-radius: 999px;
      background: linear-gradient(90deg, #6f451f, #8b5a2b);
      box-shadow: inset 0 0 0 4px rgba(255,255,255,.07);
    }

    .monkey{
      position:absolute;
      left:50%;
      bottom: 10%;
      transform: translate(-50%, 0);
      font-size: clamp(42px, 6vw, 56px);
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.18));
      transition: transform 420ms cubic-bezier(.2,.8,.2,1);
      z-index: 3;
      will-change: transform;
    }

    .monkey.falling{ animation: fall 900ms ease-in forwards; }
    @keyframes fall{
      0%   { transform: translate(-50%, 0) rotate(0deg); }
      40%  { transform: translate(-50%, 140px) rotate(25deg); }
      100% { transform: translate(-50%, 520px) rotate(120deg); opacity: .25; }
    }

    .flash-ok{ animation: flashOk 240ms ease; }
    .flash-bad{ animation: flashBad 240ms ease; }
    @keyframes flashOk{
      0%{ background: rgba(34,197,94,.18); }
      100%{ background: rgba(255,255,255,.18); }
    }
    @keyframes flashBad{
      0%{ background: rgba(239,68,68,.18); }
      100%{ background: rgba(255,255,255,.18); }
    }

    .overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      padding: 18px;
      z-index: 10;
    }
    .overlay.show{ display:flex; }

    .card{
      width: min(520px, 92vw);
      background: rgba(255,255,255,.90);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      text-align:center;
    }
    .card h1{ margin: 0 0 6px 0; font-size: 28px; }
    .card p{ margin: 0 0 14px 0; font-size: 16px; opacity:.85; line-height: 1.35; }
    .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  </style>
</head>

<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="stat" aria-label="√âletek">
        <span>√âlet:</span>
        <div class="hearts" id="hearts"></div>
      </div>

      <div class="stat" aria-label="Csillagok">
        <span>Csillag:</span>
        <div class="stars" id="stars"></div>
      </div>

      <div class="controls">
        <button class="btn-secondary" id="repeatBtn" type="button">üîä Ism√©tl√©s</button>
        <button id="startBtn" type="button">‚ñ∂Ô∏è Start</button>
      </div>
    </div>

    <div class="main" id="main">
      <div class="prompt" id="prompt">
        Nyomd meg a START-ot!
        <small>Ut√°na √©n mondom: bal vagy jobb</small>
      </div>

      <div class="playfield">
        <div class="tapzone" id="leftBtn" role="button" aria-label="Bal gomb">
          BAL
          <div class="hint">bal oldal</div>
        </div>

        <div class="treeWrap" aria-hidden="true">
          <div class="leaves"></div>
          <div class="trunk" id="trunk"></div>
          <div class="monkey" id="monkey">üêí</div>
        </div>

        <div class="tapzone" id="rightBtn" role="button" aria-label="Jobb gomb">
          JOBB
          <div class="hint">jobb oldal</div>
        </div>
      </div>

      <div class="overlay" id="overlay">
        <div class="card">
          <h1 id="endTitle">V√©ge</h1>
          <p id="endText">Kezdj√ºk √∫jra?</p>
          <div class="row">
            <button id="restartBtn" type="button">üîÅ √öj j√°t√©k</button>
            <button class="btn-secondary" id="closeOverlayBtn" type="button">‚úã M√©gse</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const heartsEl = document.getElementById('hearts');
      const starsEl  = document.getElementById('stars');
      const promptEl = document.getElementById('prompt');
      const monkeyEl = document.getElementById('monkey');

      const leftBtn  = document.getElementById('leftBtn');
      const rightBtn = document.getElementById('rightBtn');
      const startBtn = document.getElementById('startBtn');
      const repeatBtn= document.getElementById('repeatBtn');

      const overlay  = document.getElementById('overlay');
      const endTitle = document.getElementById('endTitle');
      const endText  = document.getElementById('endText');
      const restartBtn = document.getElementById('restartBtn');
      const closeOverlayBtn = document.getElementById('closeOverlayBtn');

      // Game state
      const MAX_LIVES = 3;
      const STREAK_FOR_STAR = 5;
      const MAX_STARS = 5;

      let lives = MAX_LIVES;
      let correctCount = 0;
      let stars = 0;
      let running = false;
      let current = null; // "left" | "right"
      let canAnswer = false;

      // Speech
      const synth = window.speechSynthesis;

      function pickHungarianVoice() {
        const voices = synth.getVoices?.() || [];
        return voices.find(v => (v.lang || '').toLowerCase().startsWith('hu')) || null;
      }
      let voice = null;

      function speak(text) {
        if (!synth) return;
        try { synth.cancel(); } catch(e) {}

        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'hu-HU';
        u.rate = 0.95;
        u.pitch = 1.05;
        if (voice) u.voice = voice;

        canAnswer = false;
        u.onend = () => { canAnswer = true; };
        u.onerror = () => { canAnswer = true; };

        synth.speak(u);
      }

      function renderLives() {
        heartsEl.innerHTML = '';
        for (let i = 0; i < MAX_LIVES; i++) {
          const s = document.createElement('span');
          s.className = 'heart' + (i < lives ? '' : ' muted');
          s.textContent = '‚ù§Ô∏è';
          heartsEl.appendChild(s);
        }
      }

      function renderStars() {
        starsEl.innerHTML = '';
        for (let i = 0; i < MAX_STARS; i++) {
          const s = document.createElement('span');
          s.className = 'star' + (i < stars ? '' : ' muted');
          s.textContent = '‚≠ê';
          starsEl.appendChild(s);
        }
      }

      function setPrompt(text, sub = '') {
        promptEl.innerHTML = `${text}${sub ? `<small>${sub}</small>` : ''}`;
      }

      function randomDirection() {
        return Math.random() < 0.5 ? 'left' : 'right';
      }

      // Pixel-accurate climb: uses trunk height
      function updateMonkeyPosition() {
        const trunk = document.getElementById('trunk');
        if (!trunk) return;

        const trunkRect = trunk.getBoundingClientRect();
        const maxClimb = Math.max(0, trunkRect.height - 90);
        const steps = 20;
        const step = Math.min(correctCount, steps);
        const y = -(maxClimb * (step / steps));

        monkeyEl.classList.remove('falling');
        monkeyEl.style.transform = `translate(-50%, ${y}px)`;
      }

      function flash(btnEl, ok) {
        btnEl.classList.remove('flash-ok', 'flash-bad');
        void btnEl.offsetWidth;
        btnEl.classList.add(ok ? 'flash-ok' : 'flash-bad');
      }

      function endGame(reason) {
        running = false;
        canAnswer = false;

        if (reason === 'lose') {
          monkeyEl.classList.add('falling');
          setPrompt('J√°t√©k v√©ge', 'A majom leesett üôà');
          speak('J√°t√©k v√©ge. A majom leesett a f√°r√≥l.');
          endTitle.textContent = 'J√°t√©k v√©ge';
          endText.textContent = 'Pr√≥b√°ljuk √∫jra!';
        } else if (reason === 'champion') {
          setPrompt('TE VAGY A BAJNOK! üèÜ', 'Szuper volt!');
          speak('Te vagy a bajnok!');
          endTitle.textContent = 'Te vagy a bajnok! üèÜ';
          endText.textContent = 'Szeretn√©l √∫j j√°t√©kot?';
        }

        overlay.classList.add('show');
      }

      function nextRound() {
        current = randomDirection();
        const word = current === 'left' ? 'bal' : 'jobb';
        setPrompt(`Most: ${word.toUpperCase()}!`, 'Nyomd meg a helyes oldalt');
        speak(word);
      }

      function handleAnswer(side) {
        if (!running || !canAnswer || !current) return;

        const ok = (side === current);
        const btnEl = side === 'left' ? leftBtn : rightBtn;

        if (ok) {
          flash(btnEl, true);
          correctCount += 1;
          updateMonkeyPosition();

          // star each 5 correct
          if (correctCount % STREAK_FOR_STAR === 0) {
            stars = Math.min(MAX_STARS, stars + 1);
            renderStars();
            speak('Csillag!');
            if (stars >= MAX_STARS) {
              endGame('champion');
              return;
            }
          }

          setTimeout(() => {
            if (running) nextRound();
          }, 220);

        } else {
          flash(btnEl, false);
          lives -= 1;
          renderLives();

          if (lives <= 0) {
            endGame('lose');
            return;
          }

          // repeat same instruction
          const word = current === 'left' ? 'bal' : 'jobb';
          setPrompt(`Nem baj! Pr√≥b√°ld √∫jra: ${word.toUpperCase()}!`, `Maradt √©let: ${lives}`);
          speak(`Nem baj. Pr√≥b√°ld √∫jra. ${word}`);
        }
      }

      function resetGame() {
        lives = MAX_LIVES;
        correctCount = 0;
        stars = 0;
        current = null;
        running = false;
        canAnswer = false;

        renderLives();
        renderStars();
        monkeyEl.classList.remove('falling');
        monkeyEl.style.transform = 'translate(-50%, 0)';
        setPrompt('Nyomd meg a START-ot!', 'Ut√°na √©n mondom: bal vagy jobb');
        overlay.classList.remove('show');
      }

      // iOS: voices load async
      function initVoices() {
        voice = pickHungarianVoice();
      }
      if ('speechSynthesis' in window) {
        initVoices();
        window.speechSynthesis.onvoiceschanged = () => initVoices();
      }

      // Events
      startBtn.addEventListener('click', () => {
        if (!('speechSynthesis' in window)) {
          setPrompt('Sajnos ezen a b√∂ng√©sz≈ën nincs besz√©d.', 'Pr√≥b√°ld Safari-ban iPhone-on');
          return;
        }
        overlay.classList.remove('show');
        monkeyEl.classList.remove('falling');
        running = true;

        setPrompt('K√©szen √°llsz?', 'Mindj√°rt mondom...');
        setTimeout(() => nextRound(), 300);
      });

      repeatBtn.addEventListener('click', () => {
        if (!running || !current) {
          speak('Nyomd meg a startot!');
          return;
        }
        const word = current === 'left' ? 'bal' : 'jobb';
        speak(word);
      });

      leftBtn.addEventListener('click', () => handleAnswer('left'));
      rightBtn.addEventListener('click', () => handleAnswer('right'));

      restartBtn.addEventListener('click', () => {
        resetGame();
        running = true;
        setTimeout(() => nextRound(), 300);
      });

      closeOverlayBtn.addEventListener('click', () => {
        overlay.classList.remove('show');
      });

      // Init
      resetGame();
    })();
  </script>
</body>
</html>
